# nginx configuration for kvenno.app
# Save this to /etc/nginx/sites-available/kvenno
# Then symlink: sudo ln -s /etc/nginx/sites-available/kvenno /etc/nginx/sites-enabled/
# Test: sudo nginx -t
# Reload: sudo systemctl reload nginx

# HTTP - Redirect all traffic to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name www.kvenno.app kvenno.app;
    return 301 https://$server_name$request_uri;
}

# HTTPS configuration
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.kvenno.app kvenno.app;

    ssl_certificate /etc/letsencrypt/live/www.kvenno.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.kvenno.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/kvenno.app;
    index index.html;

    types {
        application/javascript mjs;
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;

    # Note: add_header in location blocks overrides server-level headers,
    # so security headers must be repeated in any location with add_header.
    # IMPORTANT: This CSP must stay in sync with the server-level CSP below (~line 110).
    # nginx's add_header in location blocks overrides server-level headers, so both
    # copies must be updated together when changing Content-Security-Policy directives.
    location ~* \.(js|mjs|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' https://login.microsoftonline.com https://*.microsoftonline.com https://cdnjs.cloudflare.com; worker-src 'self' blob: https://cdnjs.cloudflare.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    }

    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;

        client_max_body_size 10M;
        proxy_buffering off;
    }

    location ~ ^/(1-ar|2-ar|3-ar|val|f-bekkir)(/.*)?$ {
        return 301 /efnafraedi/$1$2;
    }

    location /islenskubraut/ {
        try_files $uri $uri/ /islenskubraut/index.html;
    }

    # Lab reports SPAs (must precede the /efnafraedi/ catch-all)
    location /efnafraedi/2-ar/lab-reports/ {
        try_files $uri $uri/ /efnafraedi/2-ar/lab-reports/index.html;
    }
    location /efnafraedi/3-ar/lab-reports/ {
        try_files $uri $uri/ /efnafraedi/3-ar/lab-reports/index.html;
    }

    # MSAL auth callback â€” serves the 2-ar lab-reports build.
    # Both 2-ar and 3-ar builds share the same Azure AD app registration and
    # redirect URI (/auth/callback), so a single callback location is correct.
    # The SPA router reads the auth response and redirects to the appropriate
    # year-specific path after login.
    location /auth/callback {
        alias /var/www/kvenno.app/efnafraedi/2-ar/lab-reports/;
        try_files /index.html =404;
    }

    location /efnafraedi/ {
        try_files $uri $uri/ /index.html;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    # IMPORTANT: This CSP must stay in sync with the static-asset location CSP above (~line 40).
    # Both copies must be updated together when changing Content-Security-Policy directives.
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # style-src 'unsafe-inline' required: Tailwind CSS v4 injects styles at runtime via <style> tags
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' https://login.microsoftonline.com https://*.microsoftonline.com https://cdnjs.cloudflare.com; worker-src 'self' blob: https://cdnjs.cloudflare.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
}
